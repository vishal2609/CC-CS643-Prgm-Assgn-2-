# Use OpenJDK as base image
FROM openjdk:8-jdk

# Set environment variables
ENV HADOOP_VERSION=3.3.5 \
    SPARK_VERSION=3.3.0 \
    HADOOP_HOME=/opt/hadoop \
    SPARK_HOME=/opt/spark \
    HADOOP_CONF_DIR=/etc/hadoop/conf \
    YARN_CONF_DIR=/etc/hadoop/conf \
    PATH=$PATH:/opt/hadoop/bin:/opt/spark/bin

# Create necessary directories
RUN mkdir -p /opt && apt-get update && apt-get install -y curl tar unzip && rm -rf /var/lib/apt/lists/*

# Install Hadoop
RUN curl -LO https://downloads.apache.org/hadoop/common/hadoop-3.3.5/hadoop-3.3.5.tar.gz && \
    tar -xzf hadoop-3.3.5.tar.gz -C /opt && \
    ln -s /opt/hadoop-3.3.5 /opt/hadoop && \
    rm hadoop-3.3.5.tar.gz

# Install Spark
RUN curl -LO https://downloads.apache.org/spark/spark-3.3.0/spark-3.3.0-bin-hadoop3.tgz && \
    tar -xzf spark-3.3.0-bin-hadoop3.tgz -C /opt && \
    ln -s /opt/spark-3.3.0-bin-hadoop3 /opt/spark && \
    rm spark-3.3.0-bin-hadoop3.tgz

# Set working directory
WORKDIR /app

# Copy built JAR into container
COPY target/wine-ml-spark-1.0-SNAPSHOT.jar /app/app.jar

# Default command to run your Spark application
ENTRYPOINT ["/opt/spark/bin/spark-submit", "--class", "com.wine.WinePredictApp", "--master", "yarn", "/app/app.jar"]
