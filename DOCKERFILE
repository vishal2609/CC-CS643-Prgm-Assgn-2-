FROM bitnami/spark:3.3.0

WORKDIR /app

COPY target/wine-ml-spark-1.0-SNAPSHOT.jar /app/app.jar

# Set environment variables
ENV HADOOP_CONF_DIR=/etc/hadoop/conf
ENV YARN_CONF_DIR=/etc/hadoop/conf
ENV HOME=/root
RUN mkdir -p $HOME/.ivy2

# Add Hadoop 3.3.6 client libraries and JAX-RS dependency
RUN curl -L https://repo1.maven.org/maven2/org/apache/hadoop/hadoop-client/3.3.6/hadoop-client-3.3.6.jar -o /opt/bitnami/spark/jars/hadoop-client-3.3.6.jar && \
    curl -L https://repo1.maven.org/maven2/org/apache/hadoop/hadoop-common/3.3.6/hadoop-common-3.3.6.jar -o /opt/bitnami/spark/jars/hadoop-common-3.3.6.jar && \
    curl -L https://repo1.maven.org/maven2/org/apache/hadoop/hadoop-yarn-client/3.3.6/hadoop-yarn-client-3.3.6.jar -o /opt/bitnami/spark/jars/hadoop-yarn-client-3.3.6.jar && \
    curl -L https://repo1.maven.org/maven2/javax/ws/rs/javax.ws.rs-api/2.1.1/javax.ws.rs-api-2.1.1.jar -o /opt/bitnami/spark/jars/javax.ws.rs-api-2.1.1.jar

ENV SPARK_SUBMIT_OPTS="-Divy.cache.dir=/root/.ivy2/cache -Divy.home=/root/.ivy2"

ENTRYPOINT ["/opt/bitnami/spark/bin/spark-submit", "--class", "com.wine.WinePredictApp", "--master", "yarn", "/app/app.jar"]